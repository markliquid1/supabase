<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My History</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="container">
        <div class="settings-card">
            <div class="section-title">My History</div>

            <div id="error-message"
                style="display:none; color:#f44336; margin:15px 0; padding:10px; background:#ffebee; border-radius:4px;">
            </div>
            <div id="loading-message" style="margin:15px 0; color:#666;">Loading data...</div>

            <div id="chart-container" style="display:none; margin:20px 0;">
                <canvas id="voltageChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://qnbekuaoweuteylitzvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYmVrdWFvd2V1dGV5bGl0enZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzY1MzUsImV4cCI6MjA2NzU1MjUzNX0.k2S_kzkdAyN1Azs_7enxLun9LouB1bA_q7Sw8x1Cp0o';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let chart = null;

        // Parse token from URL
        function getTokenFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        // Validate token using Edge Function and get device_uid
        async function validateToken(token) {
            try {
                const response = await fetch('https://qnbekuaoweuteylitzvo.supabase.co/functions/v1/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYmVrdWFvd2V1dGV5bGl0enZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzY1MzUsImV4cCI6MjA2NzU1MjUzNX0.k2S_kzkdAyN1Azs_7enxLun9LouB1bA_q7Sw8x1Cp0o'
                    },
                    body: JSON.stringify({ token: token })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Invalid token');
                }

                const data = await response.json();
                return data.device_uid;
            } catch (error) {
                console.error('Token validation error:', error);
                throw new Error('Invalid or expired token');
            }
        }

        // Fetch sensor history for device
        async function fetchSensorHistory(deviceUid) {
            try {
                const { data, error } = await supabase
                    .from('sensor_history')
                    .select('timestamp, batt_volt_min, batt_volt_max, batt_volt_avg')
                    .eq('device_uid', deviceUid)
                    .order('timestamp', { ascending: true });

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Data fetch error:', error);
                throw new Error('Failed to fetch sensor data');
            }
        }

        // Create Chart.js chart
        function createChart(data) {
            const ctx = document.getElementById('voltageChart').getContext('2d');

            // Extract timestamps and voltage data
            const timestamps = data.map(d => new Date(d.timestamp));
            const minVoltages = data.map(d => d.batt_volt_min);
            const maxVoltages = data.map(d => d.batt_volt_max);
            const avgVoltages = data.map(d => d.batt_volt_avg);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'Min Voltage',
                            data: minVoltages,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Avg Voltage',
                            data: avgVoltages,
                            borderColor: '#00a19a',
                            backgroundColor: 'rgba(0, 161, 154, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Max Voltage',
                            data: maxVoltages,
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Battery Voltage History'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM d, HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Voltage (V)'
                            },
                            beginAtZero: false
                        }
                    }
                }
            });

            // Show chart, hide loading
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('chart-container').style.display = 'block';
        }

        // Main initialization
        async function init() {
            const token = getTokenFromUrl();

            if (!token) {
                showError('No authentication token provided');
                return;
            }

            try {
                // Validate token and get device_uid
                const deviceUid = await validateToken(token);

                // Fetch sensor history
                const sensorData = await fetchSensorHistory(deviceUid);

                if (!sensorData || sensorData.length === 0) {
                    showError('No sensor data available yet. Start collecting data to see your history!');
                    return;
                }

                // Create chart
                createChart(sensorData);

            } catch (error) {
                showError(error.message);
            }
        }

        // Run on page load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>