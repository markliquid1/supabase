<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My History</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="container">
        <div class="settings-card">
            <div class="section-title">My History</div>

            <div id="error-message"
                style="display:none; color:#f44336; margin:15px 0; padding:10px; background:#ffebee; border-radius:4px;">
            </div>
            <div id="loading-message" style="margin:15px 0; color:#666;">Loading data...</div>

            <!-- Plot 1: Battery Metrics -->
            <div id="plot1-container" class="chart-section" style="display:none; margin:30px 0;">
                <h3>Battery Metrics</h3>
                
                <!-- Time Range Selector -->
                <div style="margin:10px 0; padding:10px; background:#e8f5e9; border-radius:4px;">
                    <label style="font-weight:bold; margin-right:10px;">Time Range:</label>
                    <select id="timeRange1" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="all" selected>All Time</option>
                    </select>
                </div>

                <!-- Variable Toggles -->
                <div class="chart-controls" style="margin:10px 0; padding:10px; background:#f5f5f5; border-radius:4px;">
                    <label style="margin-right:15px;">
                        <input type="checkbox" class="series-toggle" data-chart="plot1" data-series="SOC"> SOC %
                    </label>
                    <label style="margin-right:15px;">
                        <input type="checkbox" class="series-toggle" data-chart="plot1" data-series="Bcur"> Battery Current
                    </label>
                    <label style="margin-right:15px;">
                        <input type="checkbox" class="series-toggle" data-chart="plot1" data-series="VictronCurrent"> Solar Current
                    </label>
                    <label style="margin-right:15px;">
                        <input type="checkbox" class="series-toggle" data-chart="plot1" data-series="MeasuredAmps" checked> Alternator Current
                    </label>
                    <label style="margin-right:15px;">
                        <input type="checkbox" class="series-toggle" data-chart="plot1" data-series="batteryVoltage"> Battery Voltage
                    </label>
                    
                    <!-- Min/Max/Avg Toggles -->
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #ddd;">
                        <label style="margin-right:10px;">
                            <input type="checkbox" class="minmaxavg-toggle" data-chart="plot1" data-type="min" checked> Min
                        </label>
                        <label style="margin-right:10px;">
                            <input type="checkbox" class="minmaxavg-toggle" data-chart="plot1" data-type="max" checked> Max
                        </label>
                        <label style="margin-right:10px;">
                            <input type="checkbox" class="minmaxavg-toggle" data-chart="plot1" data-type="avg" checked> Avg
                        </label>
                    </div>
                </div>
                <canvas id="plot1"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://qnbekuaoweuteylitzvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYmVrdWFvd2V1dGV5bGl0enZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NzY1MzUsImV4cCI6MjA2NzU1MjUzNX0.k2S_kzkdAyN1Azs_7enxLun9LouB1bA_q7Sw8x1Cp0o';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let charts = {};
        let sensorDataCache = null;

        // Parse token from URL
        function getTokenFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        // Validate token using Edge Function and get device_uid
        async function validateToken(token) {
            try {
                const response = await fetch('https://qnbekuaoweuteylitzvo.supabase.co/functions/v1/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ token: token })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Invalid token');
                }

                const data = await response.json();
                return data.device_uid;
            } catch (error) {
                console.error('Token validation error:', error);
                throw new Error('Invalid or expired token');
            }
        }

        // Fetch sensor history for device
        async function fetchSensorHistory(deviceUid) {
            try {
                const { data, error } = await supabase
                    .from('sensor_history')
                    .select(`
                        timestamp,
                        batt_volt_min, batt_volt_max, batt_volt_avg,
                        batt_curr_min, batt_curr_max, batt_curr_avg,
                        alt_curr_min, alt_curr_max, alt_curr_avg,
                        victron_curr_min, victron_curr_max, victron_curr_avg,
                        soc_min, soc_max, soc_avg
                    `)
                    .eq('device_uid', deviceUid)
                    .order('timestamp', { ascending: true });

                if (error) throw error;

                // Filter out invalid timestamps (before 2020 or after 2100)
                const minDate = new Date('2020-01-01').getTime();
                const maxDate = new Date('2100-01-01').getTime();

                const filtered = data.filter(d => {
                    const ts = new Date(d.timestamp).getTime();
                    return ts >= minDate && ts <= maxDate;
                });

                return filtered;
            } catch (error) {
                console.error('Data fetch error:', error);
                throw new Error('Failed to fetch sensor data');
            }
        }

        // Filter data by time range
        function filterDataByTimeRange(data, range) {
            if (!data || data.length === 0) return data;
            const now = new Date(data[data.length - 1].timestamp);
            let cutoffTime;
            
            switch(range) {
                case '1h': cutoffTime = new Date(now - 60 * 60 * 1000); break;
                case '6h': cutoffTime = new Date(now - 6 * 60 * 60 * 1000); break;
                case '24h': cutoffTime = new Date(now - 24 * 60 * 60 * 1000); break;
                case '7d': cutoffTime = new Date(now - 7 * 24 * 60 * 60 * 1000); break;
                case '30d': cutoffTime = new Date(now - 30 * 24 * 60 * 60 * 1000); break;
                default: return data; // 'all'
            }
            
            return data.filter(d => new Date(d.timestamp) >= cutoffTime);
        }

        // Create Plot 1: Battery Metrics (5 variables, single Y-axis)
        function createPlot1(data) {
            const ctx = document.getElementById('plot1').getContext('2d');
            
            // Get time range from dropdown
            const timeRange = document.getElementById('timeRange1')?.value || 'all';
            const filteredData = filterDataByTimeRange(data, timeRange);
            
            const timestamps = filteredData.map(d => new Date(d.timestamp));

            const datasets = [
                // SOC - Red shades
                {
                    label: 'SOC Min (%)',
                    data: filteredData.map(d => d.soc_min),
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'SOC',
                    mmavgType: 'min'
                },
                {
                    label: 'SOC Avg (%)',
                    data: filteredData.map(d => d.soc_avg),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 1)',
                    pointRadius: 2,
                    borderWidth: 2,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'SOC',
                    mmavgType: 'avg'
                },
                {
                    label: 'SOC Max (%)',
                    data: filteredData.map(d => d.soc_max),
                    borderColor: 'rgba(255, 150, 170, 0.5)',
                    backgroundColor: 'rgba(255, 150, 170, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'SOC',
                    mmavgType: 'max'
                },
                // Battery Current - Blue shades
                {
                    label: 'Batt Curr Min (A)',
                    data: filteredData.map(d => d.batt_curr_min),
                    borderColor: 'rgba(54, 162, 235, 0.5)',
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'Bcur',
                    mmavgType: 'min'
                },
                {
                    label: 'Batt Curr Avg (A)',
                    data: filteredData.map(d => d.batt_curr_avg),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 1)',
                    pointRadius: 2,
                    borderWidth: 2,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'Bcur',
                    mmavgType: 'avg'
                },
                {
                    label: 'Batt Curr Max (A)',
                    data: filteredData.map(d => d.batt_curr_max),
                    borderColor: 'rgba(120, 200, 255, 0.5)',
                    backgroundColor: 'rgba(120, 200, 255, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'Bcur',
                    mmavgType: 'max'
                },
                // Solar Current - Yellow shades
                {
                    label: 'Solar Curr Min (A)',
                    data: filteredData.map(d => d.victron_curr_min),
                    borderColor: 'rgba(255, 206, 86, 0.5)',
                    backgroundColor: 'rgba(255, 206, 86, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'VictronCurrent',
                    mmavgType: 'min'
                },
                {
                    label: 'Solar Curr Avg (A)',
                    data: filteredData.map(d => d.victron_curr_avg),
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 1)',
                    pointRadius: 2,
                    borderWidth: 2,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'VictronCurrent',
                    mmavgType: 'avg'
                },
                {
                    label: 'Solar Curr Max (A)',
                    data: filteredData.map(d => d.victron_curr_max),
                    borderColor: 'rgba(255, 230, 150, 0.5)',
                    backgroundColor: 'rgba(255, 230, 150, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'VictronCurrent',
                    mmavgType: 'max'
                },
                // Alternator Current - Teal shades
                {
                    label: 'Alt Curr Min (A)',
                    data: filteredData.map(d => d.alt_curr_min),
                    borderColor: 'rgba(75, 192, 192, 0.5)',
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: false,
                    seriesGroup: 'MeasuredAmps',
                    mmavgType: 'min'
                },
                {
                    label: 'Alt Curr Avg (A)',
                    data: filteredData.map(d => d.alt_curr_avg),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 1)',
                    pointRadius: 2,
                    borderWidth: 2,
                    fill: false,
                    hidden: false,
                    seriesGroup: 'MeasuredAmps',
                    mmavgType: 'avg'
                },
                {
                    label: 'Alt Curr Max (A)',
                    data: filteredData.map(d => d.alt_curr_max),
                    borderColor: 'rgba(140, 230, 230, 0.5)',
                    backgroundColor: 'rgba(140, 230, 230, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: false,
                    seriesGroup: 'MeasuredAmps',
                    mmavgType: 'max'
                },
                // Battery Voltage - Purple shades
                {
                    label: 'Batt Volt Min (V)',
                    data: filteredData.map(d => d.batt_volt_min),
                    borderColor: 'rgba(153, 102, 255, 0.5)',
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'batteryVoltage',
                    mmavgType: 'min'
                },
                {
                    label: 'Batt Volt Avg (V)',
                    data: filteredData.map(d => d.batt_volt_avg),
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 1)',
                    pointRadius: 2,
                    borderWidth: 2,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'batteryVoltage',
                    mmavgType: 'avg'
                },
                {
                    label: 'Batt Volt Max (V)',
                    data: filteredData.map(d => d.batt_volt_max),
                    borderColor: 'rgba(200, 170, 255, 0.5)',
                    backgroundColor: 'rgba(200, 170, 255, 0.5)',
                    pointRadius: 2,
                    borderWidth: 1.5,
                    fill: false,
                    hidden: true,
                    seriesGroup: 'batteryVoltage',
                    mmavgType: 'max'
                }
            ];

            if (charts.plot1) {
                charts.plot1.destroy();
            }

            charts.plot1 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true, 
                                pointStyle: 'circle',
                                padding: 10,
                                font: { size: 11 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Battery Metrics (Single Y-Axis: Amps/Volts/%)'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM d, HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            },
                            beginAtZero: false
                        }
                    }
                }
            });

            document.getElementById('plot1-container').style.display = 'block';
        }

        // Handle toggle controls
        function setupToggleControls() {
            // Series toggles (SOC, Battery Current, etc.)
            document.querySelectorAll('.series-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const chartId = this.dataset.chart;
                    const seriesGroup = this.dataset.series;
                    const chart = charts[chartId];
                    
                    if (!chart) return;

                    chart.data.datasets.forEach((dataset, index) => {
                        if (dataset.seriesGroup === seriesGroup) {
                            chart.setDatasetVisibility(index, this.checked);
                        }
                    });
                    chart.update();
                });
            });

            // Min/Max/Avg toggles
            document.querySelectorAll('.minmaxavg-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const chartId = this.dataset.chart;
                    const mmavgType = this.dataset.type;
                    const chart = charts[chartId];
                    
                    if (!chart) return;

                    chart.data.datasets.forEach((dataset, index) => {
                        if (dataset.mmavgType === mmavgType) {
                            chart.setDatasetVisibility(index, this.checked);
                        }
                    });
                    chart.update();
                });
            });

            // Time range selector
            document.getElementById('timeRange1')?.addEventListener('change', function() {
                if (sensorDataCache) {
                    createPlot1(sensorDataCache);
                }
            });
        }

        // Main initialization
        async function init() {
            const token = getTokenFromUrl();

            if (!token) {
                showError('No authentication token provided');
                return;
            }

            try {
                // Validate token and get device_uid
                const deviceUid = await validateToken(token);

                // Fetch sensor history
                const sensorData = await fetchSensorHistory(deviceUid);

                if (!sensorData || sensorData.length === 0) {
                    showError('No sensor data available yet. Start collecting data to see your history!');
                    return;
                }

                // Cache data for time range filtering
                sensorDataCache = sensorData;

                // Create chart
                createPlot1(sensorData);

                // Setup toggle controls
                setupToggleControls();

                // Hide loading message
                document.getElementById('loading-message').style.display = 'none';

            } catch (error) {
                showError(error.message);
            }
        }

        // Run on page load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
